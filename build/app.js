/*! anonymity 23-11-2016 */
process.env.NODE_ENV="production",process.env.PORT=80;var express=require("express"),mongoose=require("mongoose"),xml2js=require("xml2js"),parser=new xml2js.Parser,bodyParser=require("body-parser"),wordFilter=require("./wordFilter.js"),app=express();app.use(express.static(__dirname+"/public/"));var port=process.env.PORT||3e3;console.log("Express server running on "+port),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0}));var http=require("http").Server(app),io=require("socket.io")(http);http.listen(port,function(){console.log("Listening on "+port)});var wordsSchema=mongoose.Schema({words:String,color:String,weight:String,createdAt:{type:Date,default:Date.now}}),WordsModel=mongoose.model("words_model",wordsSchema),db=mongoose.connection;db.on("error",console.error),mongoose.connect("mongodb://localhost/anonymity_db"),db.once("open",function(){io.on("connection",function(a){app.post("/words",function(a,b,c){var d=a.body.words,e=wordFilter.Filtering(d),f=new WordsModel({words:e,color:a.body.color,weight:a.body.weight}),g=e.split(" ").length,h=e.split("").length;g<=51&&h<=501&&(f.save(function(a,b){if(a)throw console.err(a),a}),b?(b.send(f),io.emit("refresh feed",f)):io.emit("error"))}),app.get("/all",function(a,b,c){WordsModel.find().sort({createdAt:-1}).skip(parseInt(a.query.skip)).limit(parseInt(a.query.limit)).exec(function(a,c){if(a)throw console.log(a),a;b.send(c)})}),app.get("/count",function(a,b,c){WordsModel.count({},function(a,c){a&&console.log(a),b.send(c.toString())})})})});